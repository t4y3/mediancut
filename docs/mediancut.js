!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).MedianCut=r()}(this,function(){"use strict";var t=function(t){var r=document.createElement("canvas").getContext("2d");this.imagedata=r.createImageData(t.width,t.height),this.imagedata.data.set(t.data),this.raw=this.imagedata.data,this.width=this.imagedata.width,this.height=this.imagedata.height,this.colors=this._getColorInfo(),this.cubes=[]};return t.prototype._setProperty=function(t){for(var r=0,e=0,o=0,a=0,s=255,h=255,i=255,n=0;n<t.length;n++){var l=t[n];e=Math.max(l.r,e),o=Math.max(l.g,o),a=Math.max(l.b,a),s=Math.min(l.r,s),h=Math.min(l.g,h),i=Math.min(l.b,i),r+=l.uses}var u=1.2*(e-s),c=1.2*(o-h),g=a-i,d="r";return u>c&&u>g&&(d="r"),c>u&&c>g&&(d="g"),g>u&&g>c&&(d="b"),{color:t,total:r,type:d}},t.prototype._mediancut=function(t,r){for(var e=0,o=0,a=0;a<t.length;a++)t[a].total>e&&1!=t[a].color.length&&(o=a,e=t[a].total);if(1==t[o].total)return console.error("Cube could not be split."),t;if(1==t[o].color.length)return console.error("Cube could not be split."),t;var s=t[o].type;t[o].color.sort(function(t,r){return t[s]<r[s]?-1:t[s]>r[s]?1:0});for(var h=Math.floor((t[o].color.length+1)/2),i=[],n=[],l=0;l<t[o].color.length;l++)l<h?i[i.length]=t[o].color[l]:n[n.length]=t[o].color[l];i=this._setProperty(i),n=this._setProperty(n);for(var u=[],c=0;c<t.length;c++)c!=o&&(u[u.length]=t[c]);return u[u.length]=i,u[u.length]=n,u.length<r?this._mediancut(u,r):u},t.prototype._getColorInfo=function(){for(var t,r=0,e={},o=0;o<this.height;o++)for(var a=0;a<this.width;a++){var s=this.raw[r]+","+this.raw[r+1]+","+this.raw[r+2];e[s]?e[s]+=1:e[s]=1,r+=4}var h=[];for(var i in e)t=i.split(","),h[h.length]={r:parseInt(t[0],10),g:parseInt(t[1],10),b:parseInt(t[2],10),uses:e[i]};return h},t.prototype.getIndexColors=function(){for(var t=[],r=0;r<this.cubes.length;r++){for(var e=0,o=0,a=0,s=0,h=0;h<this.cubes[r].color.length;h++){var i=this.cubes[r].color[h];o+=i.r*i.uses,a+=i.g*i.uses,s+=i.b*i.uses,e+=i.uses}t[r]={r:Math.round(o/e),g:Math.round(a/e),b:Math.round(s/e)}}return t},t.prototype.run=function(t){this.colors.length<=t&&console.error("It has already been reduced color.");var r=[this._setProperty(this.colors)];this.cubes=this._mediancut(r,t);for(var e=this.getIndexColors(),o={},a=0;a<this.cubes.length;a++)for(var s=0;s<this.cubes[a].color.length;s++){var h=this.cubes[a].color[s];o[h.r+","+h.g+","+h.b]={r:e[a].r,g:e[a].g,b:e[a].b}}for(var i="",n=0,l=0;l<this.height;l++)for(var u=0;u<this.width;u++)i=this.raw[n]+","+this.raw[n+1]+","+this.raw[n+2],this.raw[n]=o[i].r,this.raw[n+1]=o[i].g,this.raw[n+2]=o[i].b,n+=4;return this.imagedata},t});
